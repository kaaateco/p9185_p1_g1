---
title: "Chhiring_Analysis.Rmd"
author: "Chhiring Lama"
date: "2026-02-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(readxl)
library(tidyverse)
library(knitr)
library(kableExtra)
library(janitor)
library(vcd)
library(tidymodels)
library(caret)
library(glmnet)
library(pROC)
library(gtsummary)
library(gridExtra)
library(xtable)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

options(scipen = 999)
```

Objective: The primary goal of this trial is to compare the safety profiles of Pill A, GelB and GelC, i.e. whether the medications are sage for patients

###import and clean data
```{r}
endpoint_long_dat <- read.csv("endpoints.csv")
endpoint_clean_dat <- endpoint_long_dat |> 
  mutate(
    study_sequence = paste(period1, paste(period2, period3, sep = "_"), sep = "_"), 
    AE_pillA_total = rowSums(across(starts_with("AE_pillA")), na.rm = TRUE),
    AE_gelB_total = rowSums(across(starts_with("AE_gelB")), na.rm = TRUE),
    AE_gelC_total = rowSums(across(starts_with("AE_gelC")), na.rm = TRUE), 
    ) |> 
  dplyr::select(c(ptid:period3, study_sequence, `AE_pillA_total`:`AE_gelC_total`)) |> 
  pivot_longer(cols = period1:period3,
               names_to = "period",
               values_to = "treatment") |> 
  mutate(carryover = factor(case_when(
      period == "period1" ~ "0",
      period == "period2" ~ "carryover_period1",
      period == "period3" ~ "carryover_period2")), 
      adverse_event = case_when(
        treatment == "Pill A" ~ factor(ifelse(AE_pillA_total > 0, "Yes", "No")),
        treatment == "Gel B" ~ factor(ifelse(AE_gelB_total > 0, "Yes", "No")),
        treatment == "Gel C" ~ factor(ifelse(AE_gelC_total > 0, "Yes", "No"))), 
      treatment = fct_relevel(treatment, "Pill A", "Gel B", "Gel C"), 
      seq = case_when(study_sequence %in% c("Pill A_Gel B_Gel C", "Gel B_Pill A_Gel C") ~ "0", 
                      study_sequence %in% c("Pill A_Gel C_Gel B", "Gel C_Pill A_Gel B") ~ "1", 
                      study_sequence %in% c("Gel B_Gel C_Pill A", "Gel C_Gel B_Pill A") ~ "2"), 
      seq = as.factor(seq)) |> 
  dplyr::select(-c(`AE_pillA_total`:`AE_gelC_total`)) |> 
  arrange(study_sequence)
```

```{r}
lst <- split(endpoint_clean_dat, endpoint_clean_dat$study_sequence)
```

```{r}
#pdf("EDA_figures/adverse_counts_perseq.pdf", height = "10", width = "9")
par(mfrow=c(3, 2), mar = c(2, 4, 2, 1)) 
for (i in 1:length(lst)){
  mosaicplot(~ period + adverse_event, data = lst[[i]], color = TRUE, main = names(lst)[i], xlab = "", cex.axis = 0) 
  abline(h = 0.5, col = "black", lwd = 1, lty = 2)
}
par(mfrow=c(1,1))
#dev.off()
```
Patient Distribution: 30 people in per treatment sequence
Initial Observation: Most patients do not face adverse events over the course of 4 weeks in each of the consecutive periods.

## add demographic data
```{r}
demo_data <- read_csv("baseline.csv") |> 
  dplyr::select(c(ptid, age, gender, race)) |> 
  mutate(gender = case_when(gender == 0 ~ "Male", 
                            gender == 1 ~ "Female"))
endpoint_clean_dat <- endpoint_clean_dat |> 
  full_join(demo_data, by = "ptid") |> 
  relocate(ptid, adverse_event, study_sequence) |> 
  janitor::clean_names()
```

##demographic summary
```{r, eval = FALSE}
demo_data |> 
  tbl_summary(
    gender,
    include = c(race, age)
  ) |> 
  as_kable_extra(caption = "Distributional Summary of Predictor variables in the Study", 
                 booktabs = TRUE, longtable = TRUE, linesep = "")  |> 
  kable_minimal() |> 
  kable_styling(font_size = 9)
```

```{r}
endpoint_clean_dat |> 
  tbl_strata(
    strata = c(period),
    .tbl_fun = ~ tbl_summary(
      adverse_event,
      data = .x,
      include = age
    ) |>
      add_p()
  ) |> 
  as_kable_extra(caption = "Distributional Summary of Predictor variables in the Study", 
                 booktabs = TRUE, longtable = FALSE, linesep = "")  |> 
  kable_minimal() |> 
  kable_styling(font_size = 9, latex_options = "scale_down")
```

### Notation:

$$
\begin{aligned}
k:& \text{subject}, k = 1,...,180\\
j:& \text{sequence}, j=0,1,2\\
i:& \text{period}, i=1,2,3\\
h:& \text{week}, h=1,2,3,4\\
\pi:& \text{period effect}\\
\tau:& \text{treatment effect}\\
\alpha:& \text{grouped treatment effects}\\
\beta:& \text{demographic effects}\\
\lambda:& \text{sequence/carryover effect}\\
\gamma:& \text{week effect}\\
b:& \text{subject-specific intercepts}\\
\mu:& \text{fixed-effect intercept}\\
\varepsilon:& \text{residual error}\\
\end{aligned}
$$



### Logistic Regression

### Model Results
```{r}
library(lme4)
library(nlme)
glmm1 <- glmer(adverse_event ~ treatment*period + seq + age + gender + race + (1 | ptid), 
               family = binomial, data = endpoint_clean_dat, nAGQ = 0)
# correlation of fixed effects is related to Fisher information of estimates
#random.effects(glmm1)
#fixed.effects(glmm1)
#vcov(glmm1)

glmm2 <- glmer(adverse_event ~ treatment+period + seq + age + gender + race + (1 | ptid), 
               family = binomial, data = endpoint_clean_dat, nAGQ = 0)
anova(glmm2,glmm1) ##not significant deviation between the model with and without interaction

glmm3 <- glmer(adverse_event ~ treatment + period + seq + age + (1 | ptid), 
               family = binomial, data = endpoint_clean_dat, nAGQ = 0)
anova(glmm3,glmm2) ##not significant deviation between the model with and without gender, race and period

summary(glmm3) 
final_mod <- glmm3
```


```{r}
glmm_ad_table <- tbl_regression(
  glmm3,
  exponentiate = TRUE, 
  intercept = TRUE,
  label = list(
    treatment ~ "Treatment",
    period ~ "Period",
    seq ~ "Treatment Sequence")) %>%
  bold_p() %>%
  bold_labels() %>% 
  modify_table_body(
    ~ .x %>%
      mutate(
        label = case_when(
          variable == "seq" & label == "0" ~ "ABC or BAC",
          variable == "seq" & label == "1" ~ "CAB or ACB",
          variable == "seq" & label == "2" ~ "BCA or CBA",
          TRUE ~ label)))
glmm_ad_table
```


Choosing the final model with treatment, period, sequence and age as predictors. Model is:

$$
\begin{aligned}
\widehat{logit}(P(AE_{ijk} = 1)) &= b_{ik} + \mu +\tau_{ij} +\pi_i + \lambda_{j} + \beta{a_{k}},\\ 
&\quad i = 1, 2, 3,\ j = 0, 1, 2,\ k = (1, 2, \ldots, 180),\\
&\quad b_{ik} \sim N(0, {{\sigma}^2}_b)
\end{aligned}
$$

```{r}
library(knitr)
ss <- summary(final_mod)
lme4::formatVC(ss$varcor) |> knitr::kable(caption = "random effects variances")

coef(ss) |> knitr::kable(caption = "Fixed effects", digits = 3)
```

```{r}
intercept <- broom.mixed::tidy(final_mod) |> 
  dplyr::filter(term == "(Intercept)") |> 
  pull(estimate) 

prob <- function(x){
  exp(x)/(1+exp(x))
}

prob_gelB <- prob(intercept)

log_odds_ci <- confint(final_mod, method = "Wald") |> 
  as_tibble() |> 
  drop_na()
colnames(log_odds_ci) <- c("LB", "UB")
```

```{r, fig.height=10, fig.width=8}
library(glmmTMB)
library(performance)
check_model(final_mod, residual_type = "simulated")
```

```{r, fig.height=10, fig.width=10}
library(effects)
effects_ok <- (requireNamespace("effects") && getRversion() >= "3.6.0")
par(mfrow=c(1, 3), mar = c(2, 4, 2, 1)) 
if (effects_ok) {
plot(allEffects(final_mod))
}
par(mfrow=c(1,1))
```


```{r}
ggplot(data.frame(eta=predict(final_mod,type="link"),pearson=residuals(final_mod,type="pearson")),
      aes(x=eta,y=pearson)) +
    geom_point() +
    theme_bw()
```



```{r}
# Predict the probability (p) of diabete positivity
probabilities <- predict(final_mod, type = "response")
predicted.classes <- ifelse(probabilities > 0.5, "pos", "neg")
head(predicted.classes)
```

##linearity

```{r, fig.height=3, fig.width=3.5}
# Select only numeric predictors
mydata <- endpoint_clean_dat %>%
  dplyr::select(age) 
predictors <- colnames(mydata)
# Bind the logit and tidying the data for plot
mydata <- mydata %>%
  mutate(logit = log(probabilities/(1-probabilities))) %>%
  gather(key = "predictors", value = "predictor.value", -logit)

ggplot(mydata, aes(logit, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(method = "loess") + 
  theme_bw() + 
  facet_wrap(~predictors, scales = "free_y")
```

##influential values
```{r, fig.height=10, fig.width=4}
library("sjPlot")
#pdf("random_effect_oddsand_ci.pdf", height = "20", width = "7")
plot_model(final_mod, type = "re", transform = NULL) +
  theme_classic()
#dev.off()
```

```{r, fig.width =4, fig.height =4}
plot_model(final_mod, type = "pred",
           terms = "age [all]") +
  #geom_hline(yintercept = 0, color = "black", linetype = 2, linewidth = 0.5) +
  theme_classic()
```

```{r, fig.width =5, height =4}
#pdf("fixed_effect_oddsand_ci.pdf", height = "20", width = "7")
plot_model(final_mod, type = "est", transform = "exp") +
  geom_hline(yintercept = 1, color = "black", linetype = 2, linewidth = 0.5) +
  theme_classic()
#dev.off()
```


```{r}
library(ggplot2)
#fitted(final_mod) # fixed+random for each subj in each visit, beta_0 + b_i + beta_1*age
a <- as_tibble(fitted(final_mod))
ggplot(a, aes(x = value))+
  geom_histogram(alpha = 0.2, fill = "red", color = "darkgrey")+
labs(x = "OR of Adverse Events", y = "Number of Patients", title = "Distribution of OR for Adverse Events")+
  theme_classic()
```


```{r}
glmm2 <- glmer(adverse_event ~ treatment+ period + seq + age + gender + race + (1 | ptid), 
               family = binomial, data = endpoint_clean_dat, nAGQ = 0)

```

```{r}
glmm_ad_table <- tbl_regression(
  final_mod,
  exponentiate = TRUE, 
  label = list(
    treatment ~ "Treatment",
    period ~ "Period",
    seq ~ "Treatment Sequence", 
    age ~ "Age")) %>%
  bold_p() %>%
  bold_labels() %>% 
  modify_table_body(
    ~ .x %>%
      mutate(
        label = case_when(
          variable == "sequence" & label == "0" ~ "ABC or BAC",
          variable == "sequence" & label == "1" ~ "CAB or ACB",
          variable == "sequence" & label == "2" ~ "BCA or CBA",
          TRUE ~ label)))
glmm_ad_table
```

##run LR test with a model with main effects
##try another model without sequence (and compare the models), also with and without demographic variables
## test assumptions

Not significant change in log OR between GelB and GelC, and Pill A and Gel C. 
The probability of an adverse event for gel B after accounting for age and carryover effect is `r round(prob_gelB, digits = 4)`
