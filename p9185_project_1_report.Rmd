---
title: "P9185 Project 1: Protocol of a Phase II MATIK Trial"
author: "Kate Colvin (kac2301), Chhiring Lama, Emily Carter"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Introduction

# II. 


# Secondary Objectives

```{r setup, include=FALSE}
library(readxl)
library(tidyverse)
library(knitr)
library(kableExtra)
library(table1)
library(janitor)
library(patchwork)
library(gridExtra)
library(lattice)
library(nlme)
library(broom.mixed)
library(gtsummary)
library(lme4)
library(lmerTest)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

options(scipen = 999)
```


```{r}
baseline <- read.csv("baseline.csv") %>%
  dplyr::select(-X) %>%
  mutate(carryover_period2 = period1,
         carryover_period3 = period2,
         sequence_ind = factor(case_when(
           period1 %in% c("Pill A", "Gel B") & period2 %in% c("Pill A", "Gel B") ~ 0,
           period1 %in% c("Pill A", "Gel C") & period2 %in% c("Pill A", "Gel C") ~ 1,
           .default = 2)),
         seq = factor(paste0(
    case_when(period1 == "Pill A" ~ "A",
              period1 == "Gel B"  ~ "B",
              period1 == "Gel C"  ~ "C"),
    case_when(period2 == "Pill A" ~ "A",
              period2 == "Gel B"  ~ "B",
              period2 == "Gel C"  ~ "C"),
    case_when(period3 == "Pill A" ~ "A",
              period3 == "Gel B"  ~ "B",
              period3 == "Gel C"  ~ "C"))),
    race = factor(case_when(
      race == "black" ~ "Black",
      race == "others" ~ "Other",
      race == "white" ~ "White"), levels = c("Black", "White", "Other")))


baseline_long <- baseline %>%
  pivot_longer(cols = period1:period3,
               names_to = "period",
               values_to = "treatment") %>%
  mutate(bloodVL_before = case_when(
            period == "period1" ~ bviral0,
            period == "period2" ~ bviral2,
            period == "period3" ~ bviral4),
         bloodVL_after = case_when(
            period == "period1" ~ bviral1,
            period == "period2" ~ bviral3,
            period == "period3" ~ bviral5),
         skinVL_before = case_when(
            period == "period1" ~ sviral0,
            period == "period2" ~ sviral2,
            period == "period3" ~ sviral4),
         skinVL_after = case_when(
            period == "period1" ~ sviral1,
            period == "period2" ~ sviral3,
            period == "period3" ~ sviral5),
         carryover = case_when(
            period == "period1" ~ "0",
            period == "period2" ~ carryover_period2,
            period == "period3" ~ carryover_period3)) %>%
  dplyr::select(-c(bviral0:carryover_period3)) %>%
  mutate(bloodVL_change = bloodVL_before - bloodVL_after,
         skinVL_change = skinVL_before - skinVL_after) %>%
  pivot_longer(cols = c(bloodVL_before:skinVL_after),
                          names_to = c(".value", "timepoint"),
                          names_sep = "_") %>%
  mutate(timepoint = ifelse(timepoint == "before", 0, 4)) %>%
  mutate(treatment = factor(treatment, levels = c("Pill A", "Gel B", "Gel C")))

#write.csv(baseline_long, "baseline_longformat.csv")

endpoints <- read.csv("endpoints.csv") %>%
  mutate(carryover_period2 = period1,
         carryover_period3 = period2) 

endpoints_long <- endpoints %>%
  pivot_longer(cols = period1:period3,
               names_to = "period",
               values_to = "treatment") %>%
  mutate(
    AE_pillA_total = rowSums(select(., starts_with("AE_pillA")), na.rm = TRUE),
    AE_gelB_total = rowSums(select(., starts_with("AE_gelB")), na.rm = TRUE),
    AE_gelC_total = rowSums(select(., starts_with("AE_gelC")), na.rm = TRUE),
    Adhere_pillA_total = rowSums(select(., starts_with("Adhere_pillA")), na.rm = TRUE),
    Adhere_gelB_total = rowSums(select(., starts_with("Adhere_gelB")), na.rm = TRUE),
    Adhere_gelC_total = rowSums(select(., starts_with("Adhere_gelC")), na.rm = TRUE),
    overall_safety = case_when(
      treatment == "Pill A" ~ factor(ifelse(AE_pillA_total > 0, 1, 0)),
      treatment == "Gel B" ~ factor(ifelse(AE_gelB_total > 0, 1, 0)),
      treatment == "Gel C" ~ factor(ifelse(AE_gelC_total > 0, 1, 0))),
    overall_adhere = case_when(
      treatment == "Pill A" ~ Adhere_pillA_total,
      treatment == "Gel B" ~ Adhere_gelB_total,
      treatment == "Gel C" ~ Adhere_gelC_total),
    adhere_week1 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week1,
      treatment == "Gel B" ~ Adhere_gelB_week1,
      treatment == "Gel C" ~ Adhere_gelC_week1),
    adhere_week2 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week2,
      treatment == "Gel B" ~ Adhere_gelB_week2,
      treatment == "Gel C" ~ Adhere_gelC_week2),
    adhere_week3 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week3,
      treatment == "Gel B" ~ Adhere_gelB_week3,
      treatment == "Gel C" ~ Adhere_gelC_week3),
    adhere_week4 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week4,
      treatment == "Gel B" ~ Adhere_gelB_week4,
      treatment == "Gel C" ~ Adhere_gelC_week4),
    carryover = factor(case_when(
      period == "period1" ~ "0",
      period == "period2" ~ carryover_period2,
      period == "period3" ~ carryover_period3))) %>%
  dplyr::select(-c(AE_pillA_week1:carryover_period3), -c(AE_pillA_total:AE_gelC_total), -c(Adhere_pillA_total:Adhere_gelC_total)) %>%
  pivot_longer(cols = starts_with("adhere_week"),
               names_to = "timepoint",
               values_to = "adherence") %>%
  mutate(timepoint = as.numeric(str_extract(timepoint, "\\d+")))

overall_endpoints <- endpoints_long %>%
  filter(timepoint == 1) %>%
  dplyr::select(-timepoint, -adherence)

merged <- baseline_long %>%
  filter(timepoint == 0) %>%
  dplyr::select(-timepoint, -bloodVL, -skinVL) %>% 
  left_join(overall_endpoints %>% dplyr::select(-treatment, -carryover), by = c("ptid", "period")) %>%
  mutate(overall_safety = factor(ifelse(overall_safety == 1, "Adverse Event", "No Adverse Event")))

baseline_long <- baseline_long %>%
  left_join(overall_endpoints %>% dplyr::select(-treatment, -carryover), by = c("ptid", "period"))
```


```{r}
baseline %>%
  dplyr::select(age:gender, seq) %>%
  tbl_summary(
    by = seq,
    statistic = list(
      all_continuous() ~ "{mean} ({sd}) \n[{min}, {max}]",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = list(
      age ~ "Age (years)",
      race ~ "Race",
      gender ~ "Female"
    )
  ) %>%
  add_p() %>%
  add_overall() %>%
  bold_labels() %>%
  modify_caption("**Table 1. Baseline Characteristics**")
```

preliminary assessment and comparison of systemic and local Pharmacokinetics (PK) of Pill A, Gel B, and Gel C

Blood PK Change by Treatment

$$
Y_{ik} = \mu + b_{ik} + \pi_i + \tau_{i}  + \lambda_i+\varepsilon_{ik}, \quad b_{ik} \sim N(0, \sigma_b^2), \quad \varepsilon_{ik} \sim N(0, \sigma^2)
$$

```{r}
ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = bloodVL, group = ptid, color = seq), alpha = 0.5) +
  facet_wrap(~ treatment) +
  theme_bw() +
  labs(x = "Week in Study", y = "Blood Viral Load", color = "Sequence")
```

```{r}

model <- lmer(bloodVL_change ~ treatment + period + sequence_ind + (1|ptid), data = merged)

tbl_regression(
  model,
  intercept = TRUE,
  estimate_fun = function(x) style_number(x, digits = 1)) %>%
  add_global_p() %>%
  modify_table_body(~.x %>% 
      mutate(label = case_when(
          label == "(Intercept)" ~ "Intercept (Pill A, Period 1, Sequence 0)",
          label == "Gel B" ~ "Gel B vs Pill A",
          label == "Gel C" ~ "Gel C vs Pill A",
          label == "period2" ~ "Period 2 vs Period 1",
          label == "period3" ~ "Period 3 vs Period 1",
          label == "treatment" ~ "Treatment",  # Remove header
          label == "period" ~ "Period",      # Remove header
          label == "Pill A" ~ NA_character_,
          label == "period1" ~ NA_character_,
          label == "sequence_ind" ~ "Sequence",
          label == "0" ~ NA_character_,
          label == "1" ~ "Sequence 1 vs Sequence 0",
          label == "2" ~ "Sequence 2 vs Sequence 0",
          TRUE ~ label)) %>%
      filter(!is.na(label))) %>%
  modify_header(label ~ "**Comparison**", estimate ~ "**Beta**") %>%
  bold_p(t = 0.05)
```

```{r}
resid_scaled <- residuals(model, scaled = TRUE)
fitted_vals <- fitted(model)
random_intercepts <- ranef(model)$ptid[, 1]
model_data <- model@frame

# Plot 1: Q-Q Plot for Scaled Residuals with confidence bands
p1 <- ggplot(data.frame(resid = resid_scaled), aes(sample = resid)) +
  stat_qq(alpha = 0.5) +
  stat_qq_line(color = "red", linewidth = 1) +
  labs(title = "Q-Q Plot: Scaled Residuals",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Plot 2: Histogram of Scaled Residuals with rug
p2 <- ggplot(data.frame(resid = resid_scaled), aes(x = resid)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, 
                 fill = "skyblue", color = "black", alpha = 0.7) +
  geom_density(color = "blue", linewidth = 1) +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "red", linewidth = 1, linetype = "dashed") +
  geom_rug(alpha = 0.3) +
  labs(title = "Histogram: Scaled Residuals",
       x = "Scaled Residuals",
       y = "Density",
       caption = "Red line = Normal(0,1), Blue line = Kernel density") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Plot 3: Q-Q Plot for Random Intercepts
p3 <- ggplot(data.frame(re = random_intercepts), aes(sample = re)) +
  stat_qq(alpha = 0.5) +
  stat_qq_line(color = "red", linewidth = 1) +
  labs(title = "Q-Q Plot: Random Intercepts",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Plot 4: Histogram of Random Intercepts with rug
p4 <- ggplot(data.frame(re = random_intercepts), aes(x = re)) +
  geom_histogram(aes(y = after_stat(density)), bins = 20, 
                 fill = "lightgreen", color = "black", alpha = 0.7) +
  geom_density(color = "darkgreen", linewidth = 1) +
  stat_function(fun = dnorm, 
                args = list(mean = 0, sd = sd(random_intercepts)), 
                color = "red", linewidth = 1, linetype = "dashed") +
  geom_rug(alpha = 0.3) +
  labs(title = "Histogram: Random Intercepts",
       x = "Random Intercepts (ptid)",
       y = "Density",
       caption = "Red line = Normal fit, Green line = Kernel density") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Plot 5: Residuals vs. Fitted Values with jitter
p5 <- ggplot(data.frame(fitted = fitted_vals, resid = resid_scaled), 
             aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.5, height = 0)) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  #geom_smooth(se = TRUE, color = "blue", method = "loess", linewidth = 1) +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Scaled Residuals") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Plot 6: Residuals by Treatment with individual points
p6 <- ggplot(data.frame(treatment = model_data$treatment, 
                        resid = resid_scaled),
             aes(x = treatment, y = resid)) +
  geom_boxplot(fill = "lightblue", alpha = 0.7, outlier.shape = NA) +
  #geom_jitter(width = 0.2, alpha = 0.3, color = "darkblue") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Residuals by Treatment",
       x = "Treatment",
       y = "Scaled Residuals") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Display all plots
grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2)

```


Skin PK Change by Treatment

$$
Y_{i} = \mu + \pi_i + \tau_{i}  + \lambda_{i} + \varepsilon_{i}, \quad \varepsilon_{i} \sim N(0, \sigma^2)
$$

```{r}
ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = skinVL, group = ptid, color = seq), alpha = 0.5) +
  facet_wrap(~ treatment) +
  theme_bw() +
  labs(x = "Week in Study", y = "Skin Viral Load", color = "Sequence")
```

```{r}
model <- lm(skinVL_change ~ treatment + period + sequence_ind, data = merged)

# summary(model)
tbl_regression(
  model,
  intercept = TRUE,
  estimate_fun = function(x) style_number(x, digits = 1)) %>%
  add_global_p() %>%
  modify_table_body(~.x %>% 
      mutate(label = case_when(
          label == "(Intercept)" ~ "Intercept (Pill A, Period 1, Sequence 0)",
          label == "Gel B" ~ "Gel B vs Pill A",
          label == "Gel C" ~ "Gel C vs Pill A",
          label == "period2" ~ "Period 2 vs Period 1",
          label == "period3" ~ "Period 3 vs Period 1",
          label == "treatment" ~ "Treatment",  # Remove header
          label == "period" ~ "Period",      # Remove header
          label == "Pill A" ~ NA_character_,
          label == "period1" ~ NA_character_,
          label == "sequence_ind" ~ "Sequence",
          label == "0" ~ NA_character_,
          label == "1" ~ "Sequence 1 vs Sequence 0",
          label == "2" ~ "Sequence 2 vs Sequence 0",
          TRUE ~ label)) %>%
      filter(!is.na(label))) %>%
  modify_header(label ~ "**Comparison**", estimate ~ "**Beta**") %>%
  bold_p(t = 0.05)
```

```{r}
library(ggplot2)
library(gridExtra)
library(MASS)

# Extract residuals and fitted values
residuals <- residuals(model)
fitted_values <- fitted(model)
standardized_residuals <- rstandard(model)

# 1. Q-Q Plot: Scaled Residuals
p1 <- ggplot(data.frame(residuals = standardized_residuals), aes(sample = residuals)) +
  stat_qq(color = "gray50", size = 2) +
  stat_qq_line(color = "red", linewidth = 1) +
  labs(title = "Q-Q Plot: Scaled Residuals",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()

# 2. Histogram: Scaled Residuals
p2 <- ggplot(data.frame(residuals = standardized_residuals), aes(x = residuals)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "lightblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "red", linewidth = 1) +
  geom_density(color = "blue", linewidth = 1) +
  labs(title = "Histogram: Scaled Residuals",
       x = "Scaled Residuals",
       y = "Density",
       subtitle = "Red line = Normal(0,1), Blue line = Kernel density") +
  theme_minimal()

# 3. Residuals vs. Fitted Values
p3 <- ggplot(data.frame(fitted = fitted_values, residuals = standardized_residuals), 
             aes(x = fitted, y = residuals)) +
  geom_point(color = "gray50", size = 2, alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "loess", se = FALSE, color = "red", linewidth = 1) +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Scaled Residuals") +
  theme_minimal()

# 4. Residuals by Treatment
p4 <- ggplot(data.frame(treatment = merged$treatment, residuals = standardized_residuals), 
             aes(x = treatment, y = residuals)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Residuals by Treatment",
       x = "Treatment",
       y = "Scaled Residuals") +
  theme_minimal()

# Combine all plots
grid.arrange(p1, p2, p3, p4, ncol = 2)

```

assess the correlation of PK with adherence measures and the occurrence of adverse events

Skin PK


$$
Y_{i} = \mu + \pi_i + \tau_{i}  + \lambda_{i} + \alpha_{i} + \beta_{i} +\varepsilon_{i}, \quad \varepsilon_{i} \sim N(0, \sigma^2)
$$

```{r}
ggplot(merged) +
  geom_point(aes(y = skinVL_change, x = overall_adhere, color = seq)) +
  facet_wrap(~ overall_safety + treatment) +
  theme_bw() +
  labs(x = "Overall Adherence", y = "Change in Skin PK", color = "Sequence")

ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = skinVL, group = ptid, color = overall_safety), alpha = 0.5) +
  facet_wrap(~ treatment) +
  theme_bw()
```

```{r}
model <- lm(skinVL_change ~ treatment + overall_adhere  + overall_safety + sequence_ind + period, data = merged)

summary(model)

tbl_regression(
  model,
  intercept = TRUE,
  estimate_fun = function(x) style_number(x, digits = 1)) %>%
  add_global_p() %>%
  modify_table_body(~.x %>% 
      mutate(label = case_when(
          label == "(Intercept)" ~ "Intercept (Pill A, Period 1, Sequence 0, No Adherence or AE)",
          label == "Gel B" ~ "Gel B vs Pill A",
          label == "Gel C" ~ "Gel C vs Pill A",
          label == "period2" ~ "Period 2 vs Period 1",
          label == "period3" ~ "Period 3 vs Period 1",
          label == "treatment" ~ "Treatment",  # Remove header
          label == "period" ~ "Period",      # Remove header
          label == "Pill A" ~ NA_character_,
          label == "period1" ~ NA_character_,
          label == "sequence_ind" ~ "Sequence",
          label == "0" ~ NA_character_,
          label == "1" ~ "1 vs 0",
          label == "2" ~ "2 vs 0",
          label == "overall_adhere" ~ "Additional Day of Adherence",
          label == "overall_safety" ~ "Adverse Event",
          TRUE ~ label)) %>%
      filter(!is.na(label))) %>%
  modify_header(label ~ "**Comparison**", estimate ~ "**Beta**") %>%
  bold_p(t = 0.05)
```

Blood PK


$$
Y_{ik} = \mu + b_{ik} + \pi_i + \tau_{i}  + \lambda_{i} + \alpha_{ik} + \beta_{ik} + \varepsilon_{ik}, \quad b_{ik} \sim N(0, \sigma_b^2), \quad \varepsilon_{ik} \sim N(0, \sigma^2)
$$

```{r}
ggplot(merged) +
  geom_point(aes(y = bloodVL_change, x = overall_adhere, color = seq)) +
  facet_wrap(~ overall_safety + treatment) +
  theme_bw() +
  labs(x = "Overall Adherence", y = "Change in Blood PK", color = "Sequence")

ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = bloodVL, group = ptid, color = overall_safety), alpha = 0.5) +
  facet_wrap(~ treatment) +
  theme_bw()
```


```{r}
model <- lmer(bloodVL_change ~ treatment + overall_adhere + overall_safety + sequence_ind + period + (1 | ptid),
              data = merged)

tbl_regression(
  model,
  intercept = TRUE,
  estimate_fun = function(x) style_number(x, digits = 1)) %>%
  add_global_p() %>%
  modify_table_body(~.x %>% 
      mutate(label = case_when(
          label == "(Intercept)" ~ "Intercept (Pill A, Period 1, Sequence 0, No Adherence or AE)",
          label == "Gel B" ~ "Gel B vs Pill A",
          label == "Gel C" ~ "Gel C vs Pill A",
          label == "period2" ~ "Period 2 vs Period 1",
          label == "period3" ~ "Period 3 vs Period 1",
          label == "treatment" ~ "Treatment",  # Remove header
          label == "period" ~ "Period",      # Remove header
          label == "Pill A" ~ NA_character_,
          label == "period1" ~ NA_character_,
          label == "sequence_ind" ~ "Sequence",
          label == "0" ~ NA_character_,
          label == "1" ~ "1 vs 0",
          label == "2" ~ "2 vs 0",
          label == "overall_adhere" ~ "Additional Day of Adherence",
          label == "overall_safety" ~ "Adverse Event",
          TRUE ~ label)) %>%
      filter(!is.na(label))) %>%
  modify_header(label ~ "**Comparison**", estimate ~ "**Beta**") %>%
  bold_p(t = 0.05)
```

