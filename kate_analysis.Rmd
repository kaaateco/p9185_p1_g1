---
title: "p9185_project_1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(lmerTest)
library(ggplot2)

```

## Data

```{r}

baseline <- read_csv("baseline.csv") %>% 
  janitor::clean_names()
baseline

endpoints <- read_csv("endpoints.csv") %>% 
  janitor::clean_names()
endpoints

```



## Primary Objective #2 

Comparing adherence profiles of Pill A, Gel B, and Gel C, assessing whether patients could easily adhere to medication schedules so that long term use is feasible 

```{r}

# Organizing data for this problem (selecting out variables, long format)

ad <- endpoints %>%
  mutate(seq = paste0(
    case_when(period1 == "Pill A" ~ "A",
              period1 == "Gel B"  ~ "B",
              period1 == "Gel C"  ~ "C"),
    case_when(period2 == "Pill A" ~ "A",
              period2 == "Gel B"  ~ "B",
              period2 == "Gel C"  ~ "C"),
    case_when(period3 == "Pill A" ~ "A",
              period3 == "Gel B"  ~ "B",
              period3 == "Gel C"  ~ "C")),
    sequence = case_when(
      seq %in% c("ABC", "BAC") ~ 0,
      seq %in% c("CAB", "ACB") ~ 1,
      seq %in% c("BCA", "CBA") ~ 2)) %>%
  pivot_longer(
    cols = starts_with("adhere_"),
    names_to = c("treatment", "week"),
    names_pattern = "adhere_(.*)_week(\\d)",
    values_to = "adherence") %>%
  mutate(week = as.integer(week),
         treatment_norm = case_when(
           treatment == "pill_a" ~ "Pill A",
           treatment == "gel_b" ~ "Gel B",
           treatment == "gel_c" ~ "Gel C"),
         period = case_when(
           treatment_norm == period1 ~ 1,
           treatment_norm == period2 ~ 2,
           treatment_norm == period3 ~ 3,
           TRUE ~ NA), 
         period = as.integer(period)) %>%
  filter(!is.na(period)) %>%
  mutate(
    ptid = factor(ptid),
    treatment = factor(treatment_norm, levels = c("Pill A", "Gel B", "Gel C")),
    period = factor(period),
    week = as.integer(week), 
    sequence = factor(sequence)) %>% 
  select(ptid, sequence, period, week, treatment, adherence)


# Adding demographic factors (age, race, gender)
demo <- baseline %>% 
  select("ptid", "age", "race", "gender") %>% 
  mutate(ptid = factor(ptid), 
         race = factor(race), 
         gender = factor(gender))
ad <- ad %>% left_join(demo, by = "ptid")
ad

```


Notes: 

- Week as an integer, since adherence goes down as week # increases
  - This is seen most clearly in Pill A, which has the greatest adherence to start with (seen in other plots I had made). 
  
- Excluding treatment*week as an interaction term, based on the plot below. 
  - Slopes seem to be very similar, and I double checked in the model that the interaction terms do not turn out to be statistically significant regardless. 

```{r}

ggplot(ad, aes(x = week, y = adherence, group = ptid)) +
  geom_line(alpha = 0.5) +
  geom_point(alpha = 0.5) + 
  labs(x = "Week", y = "Adherence (days/week)", 
       title = "Individual Patient Adherence Over Time") +
  theme_minimal()

ggplot(ad, aes(x = week, y = adherence, group = ptid, color = treatment)) +
  geom_line(alpha = 0.5) +
  geom_point(alpha = 0.5) + 
  stat_summary(aes(group = treatment), 
               fun = mean, geom = "line", size = 1, color = "black") +
  facet_wrap(~treatment) +
  labs(x = "Week", y = "Adherence (days/week)", 
       title = "Individual Patient Adherence Over Time, by Treatment") +
  theme_minimal()

```

```{r}

# Week as numeric
mod_num <- glmer(
  cbind(adherent, nonadherent) ~ treatment + week + period + sequence + (1 | ptid),
  family = binomial,
  data = ad,
  control = glmerControl(optimizer = "bobyqa")
)

# Week as categorical
mod_cat <- glmer(
  cbind(adherent, nonadherent) ~ treatment + factor(week) + period + sequence + (1 | ptid),
  family = binomial,
  data = ad,
  control = glmerControl(optimizer = "bobyqa")
)

summary(mod_num)
summary(mod_cat)

```


- Using Binomial Mixed Model because of model assumptions: adherence is count of successes (each day), is bounded value. 
  - The change in log-odds of daily adherence when using Gel B (or Gel C) compared to Pill A, for the same patient, holding *insert variables* constant. 
  - Initially had trouble converging, switched to using optimizer = "bobyqa", better at handling sparse or extreme binomial data (0/7 or 7/7 adherence, which is common)
  - (Never mind it seems fine now lol)


```{r}

# Reformatting for Binomial Mixed Model
ad <- ad %>%
  mutate(adherent = adherence,
         nonadherent = 7 - adherence)

# Binomial Mixed Model 
glmm_ad <- glmer(
  cbind(adherent, nonadherent) ~ treatment + week + period + sequence + (1 | ptid), 
  family = binomial(link = "logit"),
 # control = glmerControl(optimizer = "bobyqa"), 
  data = ad)
summary(glmm_ad)

```

```{r, eval = FALSE}

lmm_ad <- lmer(adherence ~ treatment*week + period + sequence + (1 | ptid), 
               data = ad)
summary(lmm_ad)

```



## Secondary Objective #2

Identify demographic factors associated with product adherence and whether they differ by product used (Pill or gel) or regimen (three times a day or once a day)

```{r}

# Adding product used and regimen to new df

ad_next <- ad %>%
  mutate(
    regimen = case_when(
      treatment == "Pill A" ~ "once",
      treatment == "Gel B"  ~ "three",
      treatment == "Gel C"  ~ "once"),
    regimen = factor(regimen), 
    product = case_when(
      treatment == "Pill A" ~ "Pill",
      treatment == "Gel B"  ~ "Gel",
      treatment == "Gel C"  ~ "Gel"), 
    product = factor(product))
ad_next

```

*PLOTS*

```{r}

glmm_demos <- glmer(
  cbind(adherent, nonadherent) ~ age*product + gender*product + race*product + 
                   age*regimen + gender*regimen + race*regimen +  
                   period + week + sequence + (1 | ptid),
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5)), 
  data = ad_next)
summary(glmm_demos)

```

```{r, eval = FALSE}

lmm_demo <- lmer(adherence ~ age*product + gender*product + race*product + 
                   age*regimen + gender*regimen + race*regimen +  
                   period + week + sequence + (1 | ptid), 
                 data = ad_next)
summary(lmm_demo)

```





## Visualizations

```{r}

ggplot(ad, aes(x = treatment, y = adherence, color = treatment)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Weekly Adherence by Treatment",
       x = "Treatment",
       y = "Adherence (days per week)")

```

```{r}

ggplot(ad_next, aes(x = treatment, y = adherence, color = treatment)) +
  geom_boxplot() +
  facet_wrap(race ~ gender) + 
  theme_minimal() +
  labs(
    title = "Adherence by Treatment, Race, and Gender",
    x = "Treatment",
    y = "Adherence (days per week)",
    fill = "Treatment")

ggplot(ad_next, aes(x = product, y = adherence, color = regimen)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Adherence by Product and Regimen",
       x = "Product",
       y = "Adherence (days)")

```


```{r}

ggplot(ad_next, aes(x = age, y = adherence, color = treatment)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Adherence vs Age by Treatment",
       x = "Age",
       y = "Adherence (days)")

ggplot(ad_next, aes(x = age, y = adherence, color = product)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Adherence vs Age by Product",
       x = "Age",
       y = "Adherence (days)")

ggplot(ad_next, aes(x = age, y = adherence, color = regimen)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  theme_minimal() +
  labs(title = "Adherence vs Age by Regimen",
       x = "Age",
       y = "Adherence (days)")

ggplot(ad_next, aes(x = week, y = adherence, color = week)) +
  geom_line() +
  theme_minimal() 
#  labs(title = "Adherence vs Age by Regimen",
#       x = "Age",
#       y = "Adherence (days)")

ggplot(ad_next) +
  geom_line(aes(x = week, y = adherence, group = ptid, color = period)) +
  facet_wrap(~ treatment) +
  theme_bw()

```

