---
title: "Emily Analysis"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(readxl)
library(tidyverse)
library(knitr)
library(kableExtra)
library(table1)
library(janitor)
library(patchwork)
library(gridExtra)
library(lattice)
library(nlme)
library(broom.mixed)
library(gtsummary)

# options(
#   ggplot2.continuous.colour = "viridis",
#   ggplot2.continuous.fill = "viridis"
# )
# 
# scale_colour_discrete = scale_colour_viridis_d
# scale_fill_discrete = scale_fill_viridis_d

options(scipen = 999)
```


```{r}
baseline <- read.csv("baseline.csv") %>%
  dplyr::select(-X) %>%
  mutate(carryover_period2 = period1,
         carryover_period3 = period2,
         sequence_ind = case_when(
           period1 %in% c("Pill A", "Gel B") & period2 %in% c("Pill A", "Gel B") ~ 0,
           period1 %in% c("Pill A", "Gel C") & period2 %in% c("Pill A", "Gel C") ~ 1,
           .default = 2),
         seq = paste0(
    case_when(period1 == "Pill A" ~ "A",
              period1 == "Gel B"  ~ "B",
              period1 == "Gel C"  ~ "C"),
    case_when(period2 == "Pill A" ~ "A",
              period2 == "Gel B"  ~ "B",
              period2 == "Gel C"  ~ "C"),
    case_when(period3 == "Pill A" ~ "A",
              period3 == "Gel B"  ~ "B",
              period3 == "Gel C"  ~ "C")),
    race = factor(case_when(
      race == "black" ~ "Black",
      race == "others" ~ "Other",
      race == "white" ~ "White"), levels = c("Black", "White", "Other")))


baseline_long <- baseline %>%
  pivot_longer(cols = period1:period3,
               names_to = "period",
               values_to = "treatment") %>%
  mutate(bloodVL_before = case_when(
            period == "period1" ~ bviral0,
            period == "period2" ~ bviral2,
            period == "period3" ~ bviral4),
         bloodVL_after = case_when(
            period == "period1" ~ bviral1,
            period == "period2" ~ bviral3,
            period == "period3" ~ bviral5),
         skinVL_before = case_when(
            period == "period1" ~ sviral0,
            period == "period2" ~ sviral2,
            period == "period3" ~ sviral4),
         skinVL_after = case_when(
            period == "period1" ~ sviral1,
            period == "period2" ~ sviral3,
            period == "period3" ~ sviral5),
         carryover = case_when(
            period == "period1" ~ "0",
            period == "period2" ~ carryover_period2,
            period == "period3" ~ carryover_period3)) %>%
  dplyr::select(-c(bviral0:carryover_period3)) %>%
  mutate(bloodVL_change = bloodVL_before - bloodVL_after,
         skinVL_change = skinVL_before - skinVL_after) %>%
  pivot_longer(cols = c(bloodVL_before:skinVL_after),
                          names_to = c(".value", "timepoint"),
                          names_sep = "_") %>%
  mutate(timepoint = ifelse(timepoint == "before", 0, 4)) %>%
  mutate(treatment = factor(treatment, levels = c("Pill A", "Gel B", "Gel C")))

#write.csv(baseline_long, "baseline_longformat.csv")

endpoints <- read.csv("endpoints.csv") %>%
  mutate(carryover_period2 = period1,
         carryover_period3 = period2) 

endpoints_long <- endpoints %>%
  pivot_longer(cols = period1:period3,
               names_to = "period",
               values_to = "treatment") %>%
  mutate(
    AE_pillA_total = rowSums(select(., starts_with("AE_pillA")), na.rm = TRUE),
    AE_gelB_total = rowSums(select(., starts_with("AE_gelB")), na.rm = TRUE),
    AE_gelC_total = rowSums(select(., starts_with("AE_gelC")), na.rm = TRUE),
    Adhere_pillA_total = rowSums(select(., starts_with("Adhere_pillA")), na.rm = TRUE),
    Adhere_gelB_total = rowSums(select(., starts_with("Adhere_gelB")), na.rm = TRUE),
    Adhere_gelC_total = rowSums(select(., starts_with("Adhere_gelC")), na.rm = TRUE),
    overall_safety = case_when(
      treatment == "Pill A" ~ factor(ifelse(AE_pillA_total > 0, 1, 0)),
      treatment == "Gel B" ~ factor(ifelse(AE_gelB_total > 0, 1, 0)),
      treatment == "Gel C" ~ factor(ifelse(AE_gelC_total > 0, 1, 0))),
    overall_adhere = case_when(
      treatment == "Pill A" ~ Adhere_pillA_total,
      treatment == "Gel B" ~ Adhere_gelB_total,
      treatment == "Gel C" ~ Adhere_gelC_total),
    adhere_week1 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week1,
      treatment == "Gel B" ~ Adhere_gelB_week1,
      treatment == "Gel C" ~ Adhere_gelC_week1),
    adhere_week2 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week2,
      treatment == "Gel B" ~ Adhere_gelB_week2,
      treatment == "Gel C" ~ Adhere_gelC_week2),
    adhere_week3 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week3,
      treatment == "Gel B" ~ Adhere_gelB_week3,
      treatment == "Gel C" ~ Adhere_gelC_week3),
    adhere_week4 = case_when(
      treatment == "Pill A" ~ Adhere_pillA_week4,
      treatment == "Gel B" ~ Adhere_gelB_week4,
      treatment == "Gel C" ~ Adhere_gelC_week4),
    carryover = factor(case_when(
      period == "period1" ~ "0",
      period == "period2" ~ carryover_period2,
      period == "period3" ~ carryover_period3))) %>%
  dplyr::select(-c(AE_pillA_week1:carryover_period3), -c(AE_pillA_total:AE_gelC_total), -c(Adhere_pillA_total:Adhere_gelC_total)) %>%
  pivot_longer(cols = starts_with("adhere_week"),
               names_to = "timepoint",
               values_to = "adherence") %>%
  mutate(timepoint = as.numeric(str_extract(timepoint, "\\d+")))


#write.csv(endpoints_long, "endpoints_longformat.csv")

overall_endpoints <- endpoints_long %>%
  filter(timepoint == 1) %>%
  dplyr::select(-timepoint, -adherence)

merged <- baseline_long %>%
  filter(timepoint == 0) %>%
  dplyr::select(-timepoint, -bloodVL, -skinVL) %>% 
  left_join(overall_endpoints %>% dplyr::select(-treatment, -carryover), by = c("ptid", "period"))

baseline_long <- baseline_long %>%
  left_join(overall_endpoints %>% dplyr::select(-treatment, -carryover), by = c("ptid", "period"))
```


```{r}
baseline %>%
  dplyr::select(age:gender, seq) %>%
  tbl_summary(
    by = seq,
    statistic = list(
      all_continuous() ~ "{mean} ({sd}) \n[{min}, {max}]",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = list(
      age ~ "Age (years)",
      race ~ "Race",
      gender ~ "Female"
    )
  ) %>%
  add_p() %>%
  add_overall() %>%
  bold_labels() %>%
  modify_caption("**Table 1. Baseline Characteristics**")
```

## preliminary assessment and comparison of systemic and local Pharmacokinetics (PK) of Pill A, Gel B, and Gel C {.tabset}

No apparent difference in starting value by period or treatment, so looking at change from baseline in PK

Carryover effects and period were excluded for parsimony, as the likelihood ratio test indicated that they did not significantly improve model fit

Notation: $i =$ subject, $j =$ treatment, 

$$
\begin{align}
Y_{ij} &= \mu + b_{i} + \tau_j  + \varepsilon_{ij},\\
b_{i} &\sim N(0, \sigma_i^2), \\
\varepsilon_{ij} &\sim N(0, \sigma^2), 
\end{align}
$$

### Blood PK Change by Treatment

```{r}
ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = bloodVL, group = ptid, color = period)) +
  facet_wrap(~ treatment) +
  theme_bw()
```


Findings: Significantly less decrease in gels vs pill A

```{r}

model_large <- lme(bloodVL_change ~ treatment + sequence_ind + period, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model <- lme(bloodVL_change ~ treatment, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model_comparison <- anova(model, model_large)
print(model_comparison)

summary(model)
# #tbl_regression(model)
# 
# tbl_regression(
#     model,
#     tidy_fun = broom.mixed::tidy,
#     include = c(`(Intercept)`, `treatmentGel B`, `treatmentGel C`),
#       label = list(
#         `(Intercept)` ~ "Intercept",
#         `treatmentGel B` ~ "Gel B (vs Pill A)",
#         `treatmentGel C` ~ "Gel C (vs Pill A)")
#     ) %>%
#       modify_column_unhide(std.error)
# vc <- VarCorr(model)
# vc_table <- data.frame(
#   Component = c("Intercept (id)", "Residual"),
#   Variance  = c(as.numeric(vc[1, "Variance"]),
#                 as.numeric(vc[2, "Variance"])),
#   SD        = c(as.numeric(vc[1, "StdDev"]),
#                 as.numeric(vc[2, "StdDev"])))
# kable(vc_table, digits = 3,
#       caption = "Variance Components")
```


```{r}


# Get residuals (various types available in nlme)
resid_response <- residuals(model, type = "response")      # Raw residuals
resid_pearson <- residuals(model, type = "pearson")        # Standardized (Pearson)
resid_normalized <- residuals(model, type = "normalized")  # Normalized residuals

# Get fitted values
fitted_vals <- fitted(model)

# Extract random effects (BLUPs for patient intercepts)
random_effects <- ranef(model)
random_intercepts <- random_effects[, "(Intercept)"]

# Q-Q plot for normalized residuals (ggplot version)
p1 <- ggplot(data.frame(resid = resid_normalized), aes(sample = resid)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Normalized Residuals",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of normalized residuals
p2 <- ggplot(data.frame(resid = resid_normalized), aes(x = resid)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, 
                 fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Normalized Residuals",
       x = "Normalized Residuals",
       y = "Density") +
  theme_bw()

# Q-Q plot for random intercepts (ggplot version)
p3 <- ggplot(data.frame(re = random_intercepts), aes(sample = re)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Random Intercepts",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of random intercepts
p4 <- ggplot(data.frame(re = random_intercepts), aes(x = re)) +
  geom_histogram(aes(y = after_stat(density)), bins = 20, 
                 fill = "lightgreen", color = "black") +
  stat_function(fun = dnorm, 
                args = list(mean = 0, sd = sd(random_intercepts)), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Random Intercepts",
       x = "Random Intercepts (ptid)",
       y = "Density") +
  theme_bw()

# Residuals vs. Fitted values
p5 <- ggplot(data.frame(fitted = fitted_vals, resid = resid_normalized), 
             aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(se = TRUE, color = "blue", method = "loess") +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Normalized Residuals") +
  theme_bw()

# Extract model data
model_data <- model$data

# Residuals by treatment
p6 <- ggplot(data.frame(treatment = model_data$treatment, 
                        resid = resid_normalized),
             aes(x = treatment, y = resid)) +
  geom_boxplot(fill = "lightblue") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals by Treatment",
       x = "Treatment",
       y = "Normalized Residuals") +
  theme_bw()


# Display ggplot diagnostics
grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```


### Skin PK Change by Treatment

```{r}
ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = skinVL, group = ptid, color = period)) +
  facet_wrap(~ treatment) +
  theme_bw()
```

Findings: Significantly less decrease in gels vs pill A

```{r}
model_large <- lme(skinVL_change ~ treatment + sequence_ind + period, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model <- lme(skinVL_change ~ treatment, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model_comparison <- anova(model, model_large)
print(model_comparison)

summary(model)
# 
# tbl_regression(
#     model,
#     tidy_fun = broom.mixed::tidy,
#     include = c(`(Intercept)`, `treatmentGel B`, `treatmentGel C`),
#       label = list(
#         `(Intercept)` ~ "Intercept",
#         `treatmentGel B` ~ "Gel B (vs Pill A)",
#         `treatmentGel C` ~ "Gel C (vs Pill A)")
#     ) %>%
#       modify_column_unhide(std.error)
# vc <- VarCorr(model)
# vc_table <- data.frame(
#   Component = c("Intercept (id)", "Residual"),
#   Variance  = c(as.numeric(vc[1, "Variance"]),
#                 as.numeric(vc[2, "Variance"])),
#   SD        = c(as.numeric(vc[1, "StdDev"]),
#                 as.numeric(vc[2, "StdDev"])))
# kable(vc_table, digits = 3,
#       caption = "Variance Components")
```


```{r}

# Get residuals (various types available in nlme)
resid_response <- residuals(model, type = "response")      # Raw residuals
resid_pearson <- residuals(model, type = "pearson")        # Standardized (Pearson)
resid_normalized <- residuals(model, type = "normalized")  # Normalized residuals

# Get fitted values
fitted_vals <- fitted(model)

# Extract random effects (BLUPs for patient intercepts)
random_effects <- ranef(model)
random_intercepts <- random_effects[, "(Intercept)"]

# Q-Q plot for normalized residuals (ggplot version)
p1 <- ggplot(data.frame(resid = resid_normalized), aes(sample = resid)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Normalized Residuals",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of normalized residuals
p2 <- ggplot(data.frame(resid = resid_normalized), aes(x = resid)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, 
                 fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Normalized Residuals",
       x = "Normalized Residuals",
       y = "Density") +
  theme_bw()

# Q-Q plot for random intercepts (ggplot version)
p3 <- ggplot(data.frame(re = random_intercepts), aes(sample = re)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Random Intercepts",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of random intercepts
p4 <- ggplot(data.frame(re = random_intercepts), aes(x = re)) +
  geom_histogram(aes(y = after_stat(density)), bins = 20, 
                 fill = "lightgreen", color = "black") +
  stat_function(fun = dnorm, 
                args = list(mean = 0, sd = sd(random_intercepts)), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Random Intercepts",
       x = "Random Intercepts (ptid)",
       y = "Density") +
  theme_bw()

# Residuals vs. Fitted values
p5 <- ggplot(data.frame(fitted = fitted_vals, resid = resid_normalized), 
             aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(se = TRUE, color = "blue", method = "loess") +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Normalized Residuals") +
  theme_bw()

# Extract model data
model_data <- model$data

# Residuals by treatment
p6 <- ggplot(data.frame(treatment = model_data$treatment, 
                        resid = resid_normalized),
             aes(x = treatment, y = resid)) +
  geom_boxplot(fill = "lightblue") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals by Treatment",
       x = "Treatment",
       y = "Normalized Residuals") +
  theme_bw()


# Display ggplot diagnostics
grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```


## assess the correlation of PK with adherence measures and the occurrence of adverse events {.tabset}


Carryover effects and period were excluded for parsimony, as the likelihood ratio test indicated that they did not significantly improve model fit

Q: include treatment X adherence and treatment X AE interaction terms???

### Skin PK

```{r}
ggplot(merged) +
  geom_point(aes(y = skinVL_change, x = overall_adhere, color = period)) +
  facet_wrap(~ overall_safety + treatment) +
  theme_bw()

ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = skinVL, group = ptid, color = overall_safety), alpha = 0.5) +
  facet_wrap(~ treatment) +
  theme_bw()
```

Skin/Blood PK ~ Random Intercept (Subject) + Treatment + Adherence + Carryover + Period

```{r}
model_large <- lme(skinVL_change ~ treatment + overall_adhere + overall_safety + sequence_ind + period, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model_large2 <- lme(skinVL_change ~ treatment*overall_adhere + treatment*overall_safety, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model <- lme(skinVL_change ~ treatment + overall_adhere  + overall_safety, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model_comparison <- anova(model, model_large2)
print(model_comparison)

summary(model)
summary(model_large2)
```


```{r}

# Get residuals (various types available in nlme)
resid_response <- residuals(model, type = "response")      # Raw residuals
resid_pearson <- residuals(model, type = "pearson")        # Standardized (Pearson)
resid_normalized <- residuals(model, type = "normalized")  # Normalized residuals

# Get fitted values
fitted_vals <- fitted(model)

# Extract random effects (BLUPs for patient intercepts)
random_effects <- ranef(model)
random_intercepts <- random_effects[, "(Intercept)"]

# Q-Q plot for normalized residuals (ggplot version)
p1 <- ggplot(data.frame(resid = resid_normalized), aes(sample = resid)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Normalized Residuals",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of normalized residuals
p2 <- ggplot(data.frame(resid = resid_normalized), aes(x = resid)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, 
                 fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Normalized Residuals",
       x = "Normalized Residuals",
       y = "Density") +
  theme_bw()

# Q-Q plot for random intercepts (ggplot version)
p3 <- ggplot(data.frame(re = random_intercepts), aes(sample = re)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Random Intercepts",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of random intercepts
p4 <- ggplot(data.frame(re = random_intercepts), aes(x = re)) +
  geom_histogram(aes(y = after_stat(density)), bins = 20, 
                 fill = "lightgreen", color = "black") +
  stat_function(fun = dnorm, 
                args = list(mean = 0, sd = sd(random_intercepts)), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Random Intercepts",
       x = "Random Intercepts (ptid)",
       y = "Density") +
  theme_bw()

# Residuals vs. Fitted values
p5 <- ggplot(data.frame(fitted = fitted_vals, resid = resid_normalized), 
             aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(se = TRUE, color = "blue", method = "loess") +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Normalized Residuals") +
  theme_bw()

# Extract model data
model_data <- model$data

# Residuals by treatment
p6 <- ggplot(data.frame(treatment = model_data$treatment, 
                        resid = resid_normalized),
             aes(x = treatment, y = resid)) +
  geom_boxplot(fill = "lightblue") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals by Treatment",
       x = "Treatment",
       y = "Normalized Residuals") +
  theme_bw()


# Display ggplot diagnostics
grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```

### Blood PK

```{r}
ggplot(merged) +
  geom_point(aes(y = bloodVL_change, x = overall_adhere, color = period)) +
  facet_wrap(~ overall_safety + treatment) +
  theme_bw()

ggplot(baseline_long) +
  geom_line(aes(x = timepoint, y = bloodVL, group = ptid, color = overall_safety), alpha = 0.5) +
  facet_wrap(~ treatment) +
  theme_bw()
```


```{r}

model_large <- lme(bloodVL_change ~ treatment + overall_adhere + overall_safety + sequence_ind + period, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model_large2 <- lme(bloodVL_change ~ treatment*overall_adhere + treatment*overall_safety, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model <- lme(bloodVL_change ~ treatment + overall_adhere  + overall_safety, method="ML",
           data = merged,
          random=reStruct(~ 1 | ptid))

model_comparison <- anova(model, model_large2)
print(model_comparison)

summary(model)
summary(model_large2)
```

```{r}

# Get residuals (various types available in nlme)
resid_response <- residuals(model, type = "response")      # Raw residuals
resid_pearson <- residuals(model, type = "pearson")        # Standardized (Pearson)
resid_normalized <- residuals(model, type = "normalized")  # Normalized residuals

# Get fitted values
fitted_vals <- fitted(model)

# Extract random effects (BLUPs for patient intercepts)
random_effects <- ranef(model)
random_intercepts <- random_effects[, "(Intercept)"]

# Q-Q plot for normalized residuals (ggplot version)
p1 <- ggplot(data.frame(resid = resid_normalized), aes(sample = resid)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Normalized Residuals",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of normalized residuals
p2 <- ggplot(data.frame(resid = resid_normalized), aes(x = resid)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, 
                 fill = "skyblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Normalized Residuals",
       x = "Normalized Residuals",
       y = "Density") +
  theme_bw()

# Q-Q plot for random intercepts (ggplot version)
p3 <- ggplot(data.frame(re = random_intercepts), aes(sample = re)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot: Random Intercepts",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_bw()

# Histogram of random intercepts
p4 <- ggplot(data.frame(re = random_intercepts), aes(x = re)) +
  geom_histogram(aes(y = after_stat(density)), bins = 20, 
                 fill = "lightgreen", color = "black") +
  stat_function(fun = dnorm, 
                args = list(mean = 0, sd = sd(random_intercepts)), 
                color = "red", linewidth = 1) +
  labs(title = "Histogram: Random Intercepts",
       x = "Random Intercepts (ptid)",
       y = "Density") +
  theme_bw()

# Residuals vs. Fitted values
p5 <- ggplot(data.frame(fitted = fitted_vals, resid = resid_normalized), 
             aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(se = TRUE, color = "blue", method = "loess") +
  labs(title = "Residuals vs. Fitted Values",
       x = "Fitted Values",
       y = "Normalized Residuals") +
  theme_bw()

# Extract model data
model_data <- model$data

# Residuals by treatment
p6 <- ggplot(data.frame(treatment = model_data$treatment, 
                        resid = resid_normalized),
             aes(x = treatment, y = resid)) +
  geom_boxplot(fill = "lightblue") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals by Treatment",
       x = "Treatment",
       y = "Normalized Residuals") +
  theme_bw()


# Display ggplot diagnostics
grid.arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```